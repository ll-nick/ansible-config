- name: Install psutil
  ansible.builtin.pip:
    name: psutil
    state: latest
    executable: "{{ ansible_env.HOME }}/.local/share/mise/shims/pip"

# Dark Mode
- name: Enable Dark Mode
  community.general.dconf:
    key: "/org/gnome/desktop/interface/color-scheme"
    value: "'prefer-dark'"

# Keyboard Settings
- name: Show all sources (required for EurKey layout to work)
  community.general.dconf:
    key: "/org/gnome/desktop/input-sources/show-all-sources"
    value: "true"

- name: Set layout
  community.general.dconf:
    key: "/org/gnome/desktop/input-sources/sources"
    value: "[('xkb', 'eu'), ('xkb', 'de')]"

- name: Make Caps Lock Escape
  community.general.dconf:
    key: "/org/gnome/desktop/input-sources/xkb-options"
    value: "['caps:escape_shifted_capslock']"

- name: Rebind screen lock to Ctrl+Alt+L
  community.general.dconf:
    key: "/org/gnome/settings-daemon/plugins/media-keys/screensaver"
    value: "['<Control><Alt>l']"

# Cursor Theme
- name: Ensure icons Directory at .icons
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.icons"
    state: directory
- name: Download Cursor Theme to .icons
  ansible.builtin.unarchive:
    src: https://github.com/catppuccin/cursors/releases/download/v2.0.0/catppuccin-mocha-blue-cursors.zip
    dest: "{{ ansible_env.HOME }}/.icons/"
    remote_src: yes
    creates: "{{ ansible_env.HOME }}/.icons/catppuccin-mocha-blue-cursors"

  # It appears that some applications only respect the cursor theme in .local/share/icons while others only respect it in .icons
  # So we'll copy the theme to both locations to ensure it works everywhere
- name: Ensure icons Directory at .local/share/icons
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.local/share/icons"
    state: directory
- name: Download Cursor Theme to .local/share/icons
  ansible.builtin.unarchive:
    src: https://github.com/catppuccin/cursors/releases/download/v2.0.0/catppuccin-mocha-blue-cursors.zip
    dest: "{{ ansible_env.HOME }}/.local/share/icons/"
    remote_src: yes
    creates: "{{ ansible_env.HOME }}/.local/share/icons/catppuccin-mocha-blue-cursors"

- name: Set Icon Theme
  community.general.dconf:
    key: "/org/gnome/desktop/interface/cursor-theme"
    value: "'catppuccin-mocha-blue-cursors'"

# Wallpaper
- name: Set Dark Mode Wallpaper
  community.general.dconf:
    key: "/org/gnome/desktop/background/picture-uri-dark"
    value: "'https://github.com/ll-nick/ansible-config/blob/main/roles/gnome/files/wallpaper-dark.png?raw=true'"

- name: Set Light Mode Wallpaper
  community.general.dconf:
    key: "/org/gnome/desktop/background/picture-uri"
    value: "'https://github.com/ll-nick/ansible-config/blob/main/roles/gnome/files/wallpaper-light.png?raw=true'"

# PaperWM
- name: Install GNOME Extension CLI
  ansible.builtin.shell: |
    {{ ansible_env.HOME }}/.local/bin/mise use --global pipx:gnome-extensions-cli
  args:
    creates: "{{ ansible_env.HOME }}/.local/share/mise/installs/pipx-gnome-extensions-cli"

- name: Query installed GNOME extensions
  ansible.builtin.command:
    cmd: gext list --only-uuid --all
  register: gext_installed
  changed_when: false
  failed_when: false

- name: Install PaperWM
  ansible.builtin.command:
    cmd: gext install "paperwm@paperwm.github.com"
  when: "'paperwm@paperwm.github.com' not in gext_installed.stdout"

- name: Query enabled GNOME extensions
  ansible.builtin.command:
    cmd: gext list --only-uuid
  register: gext_enabled
  changed_when: false
  failed_when: false

- name: Enable PaperWM
  ansible.builtin.command:
    cmd: gext enable "paperwm@paperwm.github.com"
  when: "'paperwm@paperwm.github.com' not in gext_enabled.stdout"

- name: Configure PaperWM keybindings
  community.general.dconf:
    key: "/org/gnome/shell/extensions/paperwm/keybindings"
    value: >
      {
        'close-window': ['<Super>BackSpace', '<Super>x'],
        'move-down': ['<Control><Super>Down', '<Shift><Super>j'],
        'move-down-workspace': ['<Control><Super>Page_Down', '<Shift><Alt><Super>j'],
        'move-left': ['<Control><Super>comma', '<Shift><Super>comma', '<Control><Super>Left', '<Shift><Super>h'],
        'move-right': ['<Control><Super>period', '<Shift><Super>period', '<Control><Super>Right', '<Shift><Alt>l'],
        'move-up': ['<Control><Super>Up', '<Shift><Super>k'],
        'move-up-workspace': ['<Control><Super>Page_Up', '<Shift><Alt><Super>k'],
        'new-window': ['<Super>Return'],
        'switch-down': ['<Super>Down', '<Super>j'],
        'switch-down-workspace': ['<Super>Page_Down', '<Alt><Super>j'],
        'switch-left': ['<Super>Left', '<Super>h'],
        'switch-next': ['<Super>n'],
        'switch-previous': ['<Super>p'],
        'switch-right': ['<Super>l'],
        'switch-up': ['<Super>Up', '<Super>k'],
        'switch-up-workspace': ['<Super>Page_Up', '<Alt><Super>k']
      }
